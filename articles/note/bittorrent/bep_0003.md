# [The BitTorrent Protocol Specification](http://bittorrent.org/beps/bep_0003.html) (翻译)

BitTorrent是一种用于分发文件的协议。它通过URL标识内容，旨在与Web无缝集成。 它优于普通HTTP，当同一文件的多次下载同时发生时，下载程序会相互上传，从而使文件源可以支持非常大量的下载端，负载增加不是很大。

### 一个BT正常工作需要包含以下部分：
- 一个Web服务器
- 一个静态元信息文件（'metainfo' file）
- 一个 BT 跟踪器（tracker）
- 一个初始下载器（'original' downloader）
- 用户终端浏览器
- 用户终端下载器

1个BT文件有多个用户终端。

### 启动 BT 服务，有以下步骤：
- 1.启动跟踪器（tracker）。
- 2.启动Web服务器，如 apache。
- 3.在Web服务器中用 `application/x-bittorrent` 的 mimetype 关联 .torrent 文件。
- 4.根据完整文件（供他人下载的文件）和跟踪器的URL生成元信息（.torrent）文件。
- 5.将元信息文件（.torrent）发布到其他网站上。
- 6.启动一个已经拥有完整文件（'origin'）的下载程序。

### bencoding
- 字符串类型：以十进制表示的长度为前缀，后跟冒号和字符串。 例如 "4:spam" 对应字符串 "spam"。
- 整数类型：'i' 字符后跟十进制数字，再跟 'e' 结束。例如 "i3e" 对应数字 3，"i-3e" 对应数字 -3。整数类型没有大小限制。"i-0e" 是无效的。所有以 0 为开头的编码形式，如 "i03e"，是无效的。除了 "i0e"，当然它对应 0。
- 列表类型：'l' 后跟列表元素，以 'e' 结尾。例如 "l4:spam4:eggse" 对应列表 "['spam', 'eggs']"。
- 字典类型：'d' 后跟交替的键与值的列表，以 'e' 结尾。例如 "d3:cow3:moo4:spam4:eggse" 对应 "{'cow': 'moo', 'spam': 'eggs'}"，"d4:spaml1:a1:bee" 对应 "{'spam': ['a', 'b']}"。键必须为排好序的字符类型（以原生字符串排序，而不是字母序）。

### 源信息文件（metainfo files）
源信息文件（即 .torrent 文件）其内容需要被编码成字典类型，包含下面的建：

- `announce`：跟踪器的 url。
- `info`：以下面将要描述的键构成的字典。

.torrent 文件内的文本内容都必须用 UTF-8 进行编码。

#### info 字典

`name` 的值是 UTF-8 编码的字符串，该字符串是保存文件（或目录）时的建议名称。这纯粹是建议性的。

`piece length` 的值是文件被拆分成每个部分中的字节数。 出于传输的目的，文件被分成固定大小的片段，除了可能被截断的最后一个片段之外，它们的长度都相同。`piece length` 几乎总是2的幂，最常见的是 2^18=256K（版本3.2之前的BitTorrent默认使用 2^20=1M）。

`pieces` 的值是长度为20的倍数的字符串。它被细分为长度为20的字符串，每个字符串都是相应索引处的片段的SHA1哈希值。

还有一个`length`或`files`，但不是两者都兼有。 如果存在`length`，则下载表示单个文件，否则它表示进入目录结构的一组文件。

在单个文件的情况下，`length` 表示文件的长度（以字节为单位）。

对于另一个键 `files`，在多文件情况下，其值被看作是按文件列表顺序相连的文件集。即文件列表是包含以下键的字典列表：

- `length`: 文件长度，字节单位。
- `path`: 与子目录名对应的UTF-8编码字符串列表，其中最后一个是实际文件名（零长度列表是错误情况）。

在单个文件的情况下，name 键是文件的名称，在多文件的情况下，它是目录的名称。

### 跟踪器（tracker）

跟踪器GET请求具有以下键：

- `info_hash`: 源信息文件的 `info` 值进行 sha-1 哈希。这个值几乎肯定必须被转义。注意，这个 `info` 值是元信息文件的子字符串。 info-hash 必须是.torrent文件中找到的编码内容的散列，这与对元信息文件进行解码相同，提取`info`字典并对其进行编码，当且仅当bdecoder完全验证了输入内容（例如键顺序，没有以0为开头的整数类型）。这意味着客户端必须拒绝无效的元信息文件或直接提取子字符串。 它们不得对无效数据执行解码编码。

- `peer_id`: 20 字节的字符串，用来作为下载器的 id。每个下载器在开始一个新的下载时随机生成自己的 id。

- `ip`: 可选参数，给出该对端所在的IP（或dns名称）。通常用于源下载程序（origin 文件所在的下载程序），如果它与跟踪器在同一台机器上。

- `port`: 对端（peer）监听的端口号。通常下载程序会尝试监听 6881 端口，如果被占用则依次监听 6882，6883，到 6889 还被占用的话，放弃监听。

- `uploaded`: 目前为止已经上传的总量，用十进制ascii编码。

- `downloaded`: 目前为止已经下载的总量，用十进制ascii编码。

- `left`: 这个对端（peer）仍需要下载的字节数，用十进制ascii编码。请注意，这不能通过下载和文件长度来计算，因为它可能是一个恢复（resume）状态的下载，并且有些下载的数据可能无法通过完整性检查而不得不重新下载。

- `event`: 可选参数，对应 started，completed，stopped （或者 empty，指不存在）。如果不存在，这是定期完成的通知（announcements）之一。started 通知在第一次下载开始时发送，completed 通知在下载完成时发送。如果文件在下载开始时已经完成下载，则不发送 completed 通知。下载程序在停止下载时使用 stopped 发送通知。

跟踪器响应是编码过的字典列表。 如果跟踪器响应中包含 `failure reason` 键，则该值显示了查询失败的原因，并且不需要其他键。 否则，它必须有两个键：`interval`，它指下载器在再请求需要等待的秒数。 `peers` 指对端对应的字典列表，每个字典包含`peer id`，`ip`和`port`，它们分别指对端自选ID，IP地址或dns名称，以及端口号。请注意，如果携带了 `event` 参数或需要更多对端时，下载程序可能会在非计划时间重新请求（即不做等待，立马再请求）。

通常，跟踪器都会返回一个压缩过的对端列表（peer list），见 [BEP23](bep_0023.md)

如果您想对元信息文件或跟踪器查询进行任何扩展，请与Bram Cohen协调以确保所有扩展都能兼容完成。

通常，通知的请求基于 [UDP tracker protocol](bep_0015.md)。

### 对端协议 （peer protocol）

BitTorrent 的对端协议基于 TCP 或 [uTP](bep_0029.md)。
